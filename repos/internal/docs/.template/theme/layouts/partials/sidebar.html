<div id="sidebar" aria-hidden="false">

  {{- $oldNav := "<nav id=\"TableOfContents\">" -}}
  {{- $newNav := "<nav id=\"table-of-contents\" aria-labelledby=\"toc-header\"><span class=\"heading\" id=\"toc-header\">In this page</span>" -}}
  {{ with .TableOfContents }}
  {{ replace . $oldNav $newNav | safeHTML }}
  {{ end }}

  <nav id="commands" aria-labelledby="commands-header">
    <span class="heading" id="commands-header">Commands</span>
    {{ $currentPage := . }}
    <ul>
    {{- range (union .Site.Home.Pages .Site.Home.Sections).ByWeight }}
    {{ template "command-menu-tree" (dict "page" . "base" $currentPage.RelPermalink) }}
    {{- end }}
    </ul>
  </nav>
</div>

{{ define "command-menu-tree" -}}
{{- $page := index . "page" -}}
{{- $base := index . "base" -}}
{{- $subPages := (union $page.Pages $page.Sections).ByWeight -}}
{{- $hasChildren := gt (len $subPages) 0 -}}
{{- $name := index (split (trim $page.RelPermalink "/") "/" | last 1) 0 }}
<li >
  {{- if eq $page.RelPermalink $base }}
  <strong class="command-menu-selected-prefix">{{ $name }}</strong>
  {{- else -}}
  <a href="{{ $page.Permalink }}" {{- if hasPrefix $base $page.RelPermalink }}class="command-menu-selected-prefix"{{ end }}>{{ $name }}</a>
  {{- end -}}
{{ if $hasChildren }}
<ul
  class="sub-menu"
  aria-label="{{ $name }} subcommands"
>
  {{ range $subPages }}
  {{ template "command-menu-tree" (dict "page" . "base" $base) }}
  {{ end }}
</ul>
</li>
{{ end }}
{{ end }}
